// Supabase Configuration
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global State
let state = {
    garmentImages: [],
    selectedModel: null,
    selectedBackground: null,
    currentCategory: 'woman',
    parameters: {
        pose: '',
        cameraAngle: '',
        style: '',
        lighting: '',
        // Phase 1
        colorTemp: '',
        dof: '',
        fabric: '',
        shadow: '',
        // Phase 2
        aspectRatio: '',
        lightingRatio: '',
        bgBlur: '',
        fit: '',
        // Phase 3
        postProc: '',
        envReflect: '',
        weather: '',
        motion: ''
    }
};

// Data
const models = {
    woman: [
        { id: 'w1', name: 'Ù…Ø¯Ù„ Û±', image: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=400&h=500&fit=crop' },
        { id: 'w2', name: 'Ù…Ø¯Ù„ Û²', image: 'https://images.unsplash.com/photo-1483985988355-763728e1935b?w=400&h=500&fit=crop' },
        { id: 'w3', name: 'Ù…Ø¯Ù„ Û³', image: 'https://images.unsplash.com/photo-1490481651871-ab68de25d43d?w=400&h=500&fit=crop' },
        { id: 'w4', name: 'Ù…Ø¯Ù„ Û´', image: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=400&h=500&fit=crop' }
    ],
    man: [
        { id: 'm1', name: 'Ù…Ø¯Ù„ Û±', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=500&fit=crop' },
        { id: 'm2', name: 'Ù…Ø¯Ù„ Û²', image: 'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?w=400&h=500&fit=crop' },
        { id: 'm3', name: 'Ù…Ø¯Ù„ Û³', image: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=500&fit=crop' },
        { id: 'm4', name: 'Ù…Ø¯Ù„ Û´', image: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=500&fit=crop' }
    ],
    girl: [
        { id: 'g1', name: 'Ù…Ø¯Ù„ Û±', image: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=400&h=500&fit=crop' },
        { id: 'g2', name: 'Ù…Ø¯Ù„ Û²', image: 'https://images.unsplash.com/photo-1483985988355-763728e1935b?w=400&h=500&fit=crop' }
    ],
    boy: [
        { id: 'b1', name: 'Ù…Ø¯Ù„ Û±', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=500&fit=crop' },
        { id: 'b2', name: 'Ù…Ø¯Ù„ Û²', image: 'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?w=400&h=500&fit=crop' }
    ]
};

const backgrounds = [
    { id: 'bg1', name: 'Ø§Ø³ØªÙˆØ¯ÛŒÙˆ Ø³ÙÛŒØ¯', image: 'https://images.unsplash.com/photo-1558769132-cb1aea9c0b41?w=500&h=300&fit=crop' },
    { id: 'bg2', name: 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø´Ù‡Ø±ÛŒ', image: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=500&h=300&fit=crop' },
    { id: 'bg3', name: 'Ú©Ø§ÙÙ‡ Ù…Ø¯Ø±Ù†', image: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=500&h=300&fit=crop' },
    { id: 'bg4', name: 'Ù¾Ø§Ø±Ú©', image: 'https://images.unsplash.com/photo-1519331379826-f10be5486c6f?w=500&h=300&fit=crop' },
    { id: 'bg5', name: 'Ø³Ø§Ø­Ù„', image: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=500&h=300&fit=crop' },
    { id: 'bg6', name: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡', image: 'https://images.unsplash.com/photo-1441984904996-e0b6ba687e04?w=500&h=300&fit=crop' }
];

const paramOptions = {
    pose: ['Ø§ÛŒØ³ØªØ§Ø¯Ù‡', 'Ù†Ø´Ø³ØªÙ‡', 'Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡ Ø±ÙØªÙ†', 'ØªÚ©ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡', 'Ø­Ø±Ú©ØªÛŒ'],
    cameraAngle: ['Ø±Ùˆ Ø¨Ù‡ Ø±Ùˆ', 'Ù†ÛŒÙ…â€ŒØ±Ø®', 'Ø§Ø² Ø¨Ø§Ù„Ø§', 'Ø§Ø² Ù¾Ø§ÛŒÛŒÙ†', 'Ú©Ù†Ø¬ Ø¯Ø§Ø±'],
    style: ['Ù…Ø¯Ø±Ù†', 'Ú©Ù„Ø§Ø³ÛŒÚ©', 'Ø§Ø³Ù¾Ø±Øª', 'Ø±Ø³Ù…ÛŒ', 'Ø¢ÙˆØ§Ù†Ú¯Ø§Ø±Ø¯'],
    lighting: ['Ù†ÙˆØ± Ø±ÙˆØ²', 'Ù†ÙˆØ± Ø§Ø³ØªÙˆØ¯ÛŒÙˆ', 'Ù†ÙˆØ± Ø·Ù„Ø§ÛŒÛŒ', 'Ù†ÙˆØ± Ø¯Ø±Ø§Ù…Ø§ØªÛŒÚ©', 'Ù†ÙˆØ± Ù†Ø±Ù…'],
    // Phase 1
    colorTemp: ['Ú¯Ø±Ù… (3200K)', 'Ø®Ù†Ø«ÛŒ (5500K)', 'Ø³Ø±Ø¯ (6500K)', 'Ø·Ù„Ø§ÛŒÛŒ (2800K)'],
    dof: ['Ø¹Ù…ÛŒÙ‚ (f/16)', 'Ù…ØªÙˆØ³Ø· (f/8)', 'Ú©Ù… (f/2.8)', 'Ø®ÛŒÙ„ÛŒ Ú©Ù… (f/1.4)'],
    fabric: ['Ù¾Ù†Ø¨Ù‡', 'Ú©ØªØ§Ù†', 'Ø§Ø¨Ø±ÛŒØ´Ù…', 'Ù¾Ø´Ù…ÛŒ', 'Ø³Ù†ØªØªÛŒÚ©', 'Ø¬ÛŒÙ†', 'Ú†Ø±Ù…'],
    shadow: ['Ù†Ø±Ù… Ùˆ Ù¾Ø®Ø´', 'Ù…ØªÙˆØ³Ø·', 'Ø³Ø®Øª Ùˆ ÙˆØ§Ø¶Ø­', 'Ø¨Ø¯ÙˆÙ† Ø³Ø§ÛŒÙ‡'],
    // Phase 2
    aspectRatio: ['Û³:Û´ (Ù¾Ø±ØªØ±Ù‡)', 'Û±:Û± (Ù…Ø±Ø¨Ø¹)', 'Û¹:Û±Û¶ (Ø§Ø³ØªÙˆØ±ÛŒ)', 'Û´:Ûµ (Ù¾Ø³Øª)'],
    lightingRatio: ['Û²:Û± (Ù†Ø±Ù…)', 'Û³:Û± (Ù…ØªÙˆØ³Ø·)', 'Û´:Û± (Ø¯Ø±Ø§Ù…Ø§ØªÛŒÚ©)', 'Û¸:Û± (Ø³Ø®Øª)'],
    bgBlur: ['Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒ', 'ØªØ§Ø±ÛŒ Ú©Ù…', 'ØªØ§Ø±ÛŒ Ù…ØªÙˆØ³Ø·', 'ØªØ§Ø±ÛŒ Ø²ÛŒØ§Ø¯', 'Ø¨ÙˆÚ©Ù‡'],
    fit: ['Ø§Ø³Ù„ÛŒÙ… ÙÛŒØª', 'Ø±Ú¯ÙˆÙ„Ø§Ø± ÙÛŒØª', 'Ø§ÙˆØ±Ø³Ø§ÛŒØ²', 'ØªØ§ÛŒØª ÙÛŒØª'],
    // Phase 3
    postProc: ['Ø·Ø¨ÛŒØ¹ÛŒ', 'Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ', 'ÙˆÛŒÙ†ØªÛŒØ¬', 'Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„', 'Ù‡Ø§ÛŒÙ¾Ø± Ø±Ø¦Ø§Ù„'],
    envReflect: ['Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø²ØªØ§Ø¨', 'Ø¨Ø§Ø²ØªØ§Ø¨ Ú©Ù…', 'Ø¨Ø§Ø²ØªØ§Ø¨ Ø·Ø¨ÛŒØ¹ÛŒ', 'Ø¨Ø§Ø²ØªØ§Ø¨ Ø²ÛŒØ§Ø¯'],
    weather: ['Ø¢ÙØªØ§Ø¨ÛŒ', 'Ø§Ø¨Ø±ÛŒ', 'Ø·Ù„ÙˆØ¹/ØºØ±ÙˆØ¨', 'Ø´Ø¨', 'Ø¨Ø§Ø±Ø§Ù†'],
    motion: ['Ø¨Ø¯ÙˆÙ† Ø­Ø±Ú©Øª', 'Ø­Ø±Ú©Øª Ù…Ùˆ', 'Ø­Ø±Ú©Øª Ù„Ø¨Ø§Ø³', 'Ø­Ø±Ú©Øª Ú©Ø§Ù…Ù„']
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initializeUpload();
    initializeCategories();
    initializeParameters();
    loadModels(state.currentCategory);
    loadBackgrounds();
    checkGenerateButton();
});

// Upload Initialization
function initializeUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const garmentInput = document.getElementById('garmentInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');

    uploadPlaceholder.addEventListener('click', () => {
        garmentInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    garmentInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
}

// Handle File Upload
function handleFiles(files) {
    const fileArray = Array.from(files);
    
    fileArray.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.garmentImages.push({
                    id: Date.now() + Math.random(),
                    file: file,
                    dataUrl: e.target.result
                });
                renderGarmentPreviews();
                checkGenerateButton();
            };
            reader.readAsDataURL(file);
        }
    });
}

// Render Garment Previews
function renderGarmentPreviews() {
    const previewsContainer = document.getElementById('garmentPreviews');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    
    if (state.garmentImages.length > 0) {
        uploadPlaceholder.style.display = 'none';
        previewsContainer.style.display = 'grid';
        
        previewsContainer.innerHTML = state.garmentImages.map(img => `
            <div class="preview-item">
                <img src="${img.dataUrl}" alt="Garment" class="preview-image">
                <button class="preview-remove" onclick="removeGarment('${img.id}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        `).join('');
    } else {
        uploadPlaceholder.style.display = 'block';
        previewsContainer.style.display = 'none';
    }
}

// Remove Garment
function removeGarment(id) {
    state.garmentImages = state.garmentImages.filter(img => img.id !== id);
    renderGarmentPreviews();
    checkGenerateButton();
}

// Initialize Categories
function initializeCategories() {
    const categoryTabs = document.querySelectorAll('.category-tab');
    
    categoryTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            categoryTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentCategory = tab.dataset.category;
            loadModels(state.currentCategory);
        });
    });
}

// Load Models
function loadModels(category) {
    const modelsGrid = document.getElementById('modelsGrid');
    const categoryModels = models[category] || [];
    
    modelsGrid.innerHTML = categoryModels.map(model => `
        <div class="model-card ${state.selectedModel === model.id ? 'selected' : ''}" onclick="selectModel('${model.id}')">
            <img src="${model.image}" alt="${model.name}" class="model-image">
            <span class="model-badge">${state.selectedModel === model.id ? 'âœ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡' : 'Ø§Ù†ØªØ®Ø§Ø¨'}</span>
            <div class="model-info">
                <div class="model-name">${model.name}</div>
            </div>
        </div>
    `).join('');
}

// Select Model
function selectModel(modelId) {
    state.selectedModel = modelId;
    loadModels(state.currentCategory);
    checkGenerateButton();
}

// Load Backgrounds
function loadBackgrounds() {
    const backgroundsGrid = document.getElementById('backgroundsGrid');
    
    backgroundsGrid.innerHTML = backgrounds.map(bg => `
        <div class="background-card ${state.selectedBackground === bg.id ? 'selected' : ''}" onclick="selectBackground('${bg.id}')">
            <img src="${bg.image}" alt="${bg.name}" class="background-image">
            <div class="background-overlay">
                <div class="background-name">${bg.name}</div>
            </div>
        </div>
    `).join('');
}

// Select Background
function selectBackground(bgId) {
    state.selectedBackground = bgId;
    loadBackgrounds();
    checkGenerateButton();
}

// Initialize Parameters
function initializeParameters() {
    // Basic parameters
    populateSelect('poseSelect', paramOptions.pose);
    populateSelect('cameraAngleSelect', paramOptions.cameraAngle);
    populateSelect('styleSelect', paramOptions.style);
    populateSelect('lightingSelect', paramOptions.lighting);
    
    // Phase 1
    populateSelect('colorTempSelect', paramOptions.colorTemp);
    populateSelect('dofSelect', paramOptions.dof);
    populateSelect('fabricSelect', paramOptions.fabric);
    populateSelect('shadowSelect', paramOptions.shadow);
    
    // Phase 2
    populateSelect('aspectRatioSelect', paramOptions.aspectRatio);
    populateSelect('lightingRatioSelect', paramOptions.lightingRatio);
    populateSelect('bgBlurSelect', paramOptions.bgBlur);
    populateSelect('fitSelect', paramOptions.fit);
    
    // Phase 3
    populateSelect('postProcSelect', paramOptions.postProc);
    populateSelect('envReflectSelect', paramOptions.envReflect);
    populateSelect('weatherSelect', paramOptions.weather);
    populateSelect('motionSelect', paramOptions.motion);
    
    // Add event listeners
    addParameterListeners();
}

// Populate Select
function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
}

// Add Parameter Listeners
function addParameterListeners() {
    const paramIds = [
        'poseSelect', 'cameraAngleSelect', 'styleSelect', 'lightingSelect',
        'colorTempSelect', 'dofSelect', 'fabricSelect', 'shadowSelect',
        'aspectRatioSelect', 'lightingRatioSelect', 'bgBlurSelect', 'fitSelect',
        'postProcSelect', 'envReflectSelect', 'weatherSelect', 'motionSelect'
    ];
    
    paramIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', (e) => {
                const paramName = id.replace('Select', '');
                state.parameters[paramName] = e.target.value;
            });
        }
    });
}

// Toggle Phase
function togglePhase(button) {
    const phase = button.closest('.quality-phase');
    const content = phase.querySelector('.phase-content');
    const isOpen = button.classList.contains('active');
    
    if (isOpen) {
        button.classList.remove('active');
        content.classList.remove('open');
    } else {
        button.classList.add('active');
        content.classList.add('open');
    }
}

// Check Generate Button
function checkGenerateButton() {
    const generateBtn = document.getElementById('generateBtn');
    const canGenerate = state.garmentImages.length > 0 && 
                       state.selectedModel && 
                       state.selectedBackground;
    
    generateBtn.disabled = !canGenerate;
}

// Generate Button Click
document.getElementById('generateBtn')?.addEventListener('click', generateImage);

async function generateImage() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultSection = document.getElementById('resultSection');
    
    // Show loading
    loadingOverlay.style.display = 'flex';
    resultSection.style.display = 'none';
    
    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 95) progress = 95;
        updateProgress(progress);
    }, 500);
    
    try {
        // Simulate AI processing
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        // Clear progress interval
        clearInterval(progressInterval);
        updateProgress(100);
        
        // Hide loading and show result
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            showResult();
        }, 500);
        
    } catch (error) {
        console.error('Error generating image:', error);
        clearInterval(progressInterval);
        loadingOverlay.style.display = 'none';
        showNotification('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
    }
}

// Update Progress
function updateProgress(percentage) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    if (progressFill && progressText) {
        progressFill.style.width = percentage + '%';
        progressText.textContent = Math.round(percentage) + '%';
    }
}

// Show Result
function showResult() {
    const resultSection = document.getElementById('resultSection');
    const resultImage = document.getElementById('resultImage');
    const resultDetails = document.getElementById('resultDetails');
    
    // Use first garment image as result (in real app, this would be the generated image)
    resultImage.src = state.garmentImages[0].dataUrl;
    
    // Display details
    const selectedModel = models[state.currentCategory].find(m => m.id === state.selectedModel);
    const selectedBg = backgrounds.find(bg => bg.id === state.selectedBackground);
    
    resultDetails.innerHTML = `
        <div class="info-row">
            <span class="info-label">Ù…Ø¯Ù„:</span>
            <span class="info-value">${selectedModel?.name || '-'}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡:</span>
            <span class="info-value">${selectedBg?.name || '-'}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</span>
            <span class="info-value">${getCategoryName(state.currentCategory)}</span>
        </div>
        <div class="info-row">
            <span class="info-label">ÙˆØ¶ÙˆØ­:</span>
            <span class="info-value">4K</span>
        </div>
        ${state.parameters.pose ? `
        <div class="info-row">
            <span class="info-label">Ø­Ø§Ù„Øª:</span>
            <span class="info-value">${state.parameters.pose}</span>
        </div>
        ` : ''}
        ${state.parameters.lighting ? `
        <div class="info-row">
            <span class="info-label">Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ:</span>
            <span class="info-value">${state.parameters.lighting}</span>
        </div>
        ` : ''}
    `;
    
    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth' });
    
    // Save to Supabase (optional)
    saveGeneratedImage();
}

// Save Generated Image
async function saveGeneratedImage() {
    try {
        const { data, error } = await supabase
            .from('generated_images')
            .insert([
                {
                    image_url: state.garmentImages[0].dataUrl,
                    model_type: state.selectedModel,
                    background: state.selectedBackground,
                    parameters: state.parameters,
                    created_at: new Date().toISOString()
                }
            ]);
        
        if (error) throw error;
        console.log('Image saved to database');
    } catch (error) {
        console.error('Error saving image:', error);
    }
}

// Get Category Name
function getCategoryName(category) {
    const names = {
        woman: 'Ø²Ù†',
        man: 'Ù…Ø±Ø¯',
        girl: 'Ø¯Ø®ØªØ±',
        boy: 'Ù¾Ø³Ø±'
    };
    return names[category] || category;
}

// Download Button
document.getElementById('downloadBtn')?.addEventListener('click', () => {
    const resultImage = document.getElementById('resultImage');
    const link = document.createElement('a');
    link.href = resultImage.src;
    link.download = `AI-Fashion-${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯', 'success');
});

// Share Image
function shareImage() {
    const resultImage = document.getElementById('resultImage');
    
    if (navigator.share) {
        fetch(resultImage.src)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], 'image.jpg', { type: 'image/jpeg' });
                return navigator.share({
                    files: [file],
                    title: 'ØªØµÙˆÛŒØ± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ',
                    text: 'Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ø§Ø³ØªÙˆØ¯ÛŒÙˆ AI'
                });
            })
            .catch(err => console.error('Error sharing:', err));
    } else {
        showNotification('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'error');
    }
}

// Generate Another
function generateAnother() {
    const resultSection = document.getElementById('resultSection');
    resultSection.style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// View Full Image
function viewFullImage() {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const resultImage = document.getElementById('resultImage');
    
    modalImage.src = resultImage.src;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close Image Modal
function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Handle Logout
function handleLogout() {
    localStorage.removeItem('user');
    showNotification('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'success');
    setTimeout(() => {
        window.location.href = '/login.html';
    }, 1000);
}

// Show Notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Add notification styles
const style = document.createElement('style');
style.textContent = `
    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 99999;
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .notification.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    
    .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        font-weight: 600;
    }
    
    .notification-success {
        border-right: 4px solid #2ecc71;
    }
    
    .notification-error {
        border-right: 4px solid #ff4757;
    }
    
    .notification-info {
        border-right: 4px solid #667eea;
    }
`;
document.head.appendChild(style);

// Check for regenerate flag
if (window.location.search.includes('regenerate=true')) {
    const settings = localStorage.getItem('regenerateSettings');
    if (settings) {
        const parsed = JSON.parse(settings);
        state.selectedModel = parsed.model_type;
        state.selectedBackground = parsed.background;
        localStorage.removeItem('regenerateSettings');
        showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯', 'success');
    }
}

console.log('ğŸ¨ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
console.log('âœ¨ ØªÙ…Ø§Ù… Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯Ù†Ø¯');