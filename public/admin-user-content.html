<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Content Management | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin-style.css">
    <style>
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 30px;
        }

        .upload-section h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .content-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .content-card-body {
            padding: 15px;
        }

        .content-card h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }

        .content-card p {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: #777;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-model { background: #e3f2fd; color: #1976d2; }
        .badge-background { background: #f3e5f5; color: #7b1fa2; }
        .badge-private { background: #fff3cd; color: #856404; }
        .badge-public { background: #dfe6e9; color: #2d3436; }

        .btn-delete {
            background: #ff6b6b;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-delete:hover {
            background: #ee5a6f;
        }

        .user-selector {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #667eea;
            margin-bottom: 25px;
        }

        .user-selector h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 16px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            background: white;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <circle cx="20" cy="20" r="18" fill="white" opacity="0.2"/>
                    <path d="M20 10 L12 18 L20 26 L28 18 Z" fill="white"/>
                </svg>
                <span>Admin Panel</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="/admin/users" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
                <span>Users</span>
            </a>
            <a href="/admin/content" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                <span>Content</span>
            </a>
            <a href="/admin/user-content" class="nav-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>User Content</span>
            </a>
            <a href="/admin/analytics" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"/>
                </svg>
                <span>Analytics</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <button class="btn-logout" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <div>
                <h1>User Content Management</h1>
                <p>Add custom models and backgrounds for users</p>
            </div>
        </header>

        <div class="content-section">
            <div id="alert-container"></div>

            <!-- User Selector -->
            <div class="user-selector">
                <h3>üë§ Select User</h3>
                <div class="form-group" style="margin-bottom: 0;">
                    <select id="selectedUser" onchange="loadUserContent()" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-weight: 600;">
                        <option value="">Loading users...</option>
                    </select>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <h2>üì§ Upload Content for Selected User</h2>
                <form id="uploadForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Content Type *</label>
                            <select id="contentType" required onchange="updateCategoryOptions()">
                                <option value="model">Model (ŸÖÿØŸÑ)</option>
                                <option value="background">Background (Ÿæÿ≥‚Äåÿ≤ŸÖ€åŸÜŸá)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Visibility *</label>
                            <select id="visibility" required>
                                <option value="private">Private (Only This User)</option>
                                <option value="public">Public (Everyone)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Category (ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å) *</label>
                        <select id="category" required>
                            <!-- Will be populated by JS -->
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="name" required placeholder="e.g., Elegant Woman Model">
                        </div>

                        <div class="form-group">
                            <label>Upload Image *</label>
                            <input type="file" id="contentFile" accept="image/*" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <textarea id="description" rows="3" placeholder="Add a description..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary">‚úÖ Upload Content</button>
                </form>
            </div>

            <!-- AI Generation Section -->
            <div class="upload-section">
                <h2>ü§ñ Generate with AI</h2>

                <div class="form-group">
                    <label>Prompt (ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™) *</label>
                    <textarea id="aiPrompt" rows="4" placeholder="Describe the image you want to generate..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Content Type *</label>
                        <select id="aiContentType">
                            <option value="model">Model (ŸÖÿØŸÑ)</option>
                            <option value="background">Background (Ÿæÿ≥‚Äåÿ≤ŸÖ€åŸÜŸá)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Aspect Ratio</label>
                        <select id="aiAspectRatio">
                            <option value="1:1">Square (1:1)</option>
                            <option value="3:4" selected>Portrait (3:4)</option>
                            <option value="4:3">Landscape (4:3)</option>
                            <option value="16:9">Wide (16:9)</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateAIImage()" class="btn-primary" id="generateBtn">
                    ‚ú® Generate Image
                </button>

                <!-- Generated Image Preview -->
                <div id="aiPreview" style="display: none; margin-top: 20px;">
                    <div style="background: #f8f9ff; padding: 20px; border-radius: 15px; border: 2px solid #667eea;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">Generated Image Preview</h3>
                        <img id="generatedImage" src="" alt="Generated" style="width: 100%; max-width: 500px; border-radius: 10px; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Save as Type *</label>
                                <select id="saveContentType" onchange="updateSaveCategoryOptions()">
                                    <option value="model">Model (ŸÖÿØŸÑ)</option>
                                    <option value="background">Background (Ÿæÿ≥‚Äåÿ≤ŸÖ€åŸÜŸá)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Category (ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å) *</label>
                                <select id="saveCategory">
                                    <!-- Will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="saveName" placeholder="Give your content a name">
                        </div>

                        <div class="form-group">
                            <label>Visibility *</label>
                            <select id="saveVisibility">
                                <option value="private">Private (Only This User)</option>
                                <option value="public">Public (Everyone)</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="saveGeneratedContent()" class="btn-primary">üíæ Save to User Content</button>
                            <button onclick="discardGenerated()" style="background: #6c757d; color: white; padding: 14px 30px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">
                                ‚ùå Discard
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User's Content Library -->
            <div class="upload-section">
                <h2>üìö User's Content Library</h2>
                <div id="userContent" class="content-grid">
                    <div class="empty-state">Select a user to view their content</div>
                </div>
            </div>
        </div>
    </main>

    <script src="/admin-common.js"></script>
    <script>
        let allUsers = [];
        let selectedUserId = null;
        let generatedImageData = null;

        // Category definitions
        const modelCategories = [
            { value: 'woman', label: 'ÿ≤ŸÜ (Woman)' },
            { value: 'man', label: 'ŸÖÿ±ÿØ (Man)' },
            { value: 'child', label: '⁄©ŸàÿØ⁄© (Child)' },
            { value: 'boy', label: 'Ÿæÿ≥ÿ± (Boy)' },
            { value: 'girl', label: 'ÿØÿÆÿ™ÿ± (Girl)' },
            { value: 'couple', label: 'ÿ≤Ÿàÿ¨ (Couple)' },
            { value: 'group', label: '⁄Øÿ±ŸàŸá (Group)' },
            { value: 'elderly', label: 'ÿ≥ÿßŸÑŸÖŸÜÿØ (Elderly)' },
            { value: 'teen', label: 'ŸÜŸàÿ¨ŸàÿßŸÜ (Teen)' },
            { value: 'plus-size', label: 'ÿ≥ÿß€åÿ≤ ÿ®ÿ≤ÿ±⁄Ø (Plus Size)' }
        ];

        const backgroundCategories = [
            { value: 'indoor', label: 'ÿØÿßÿÆŸÑ€å (Indoor)' },
            { value: 'outdoor', label: 'ÿÆÿßÿ±ÿ¨€å (Outdoor)' },
            { value: 'urban', label: 'ÿ¥Ÿáÿ±€å (Urban)' },
            { value: 'nature', label: 'ÿ∑ÿ®€åÿπÿ™ (Nature)' },
            { value: 'studio', label: 'ÿßÿ≥ÿ™ŸàÿØ€åŸà (Studio)' },
            { value: 'street', label: 'ÿÆ€åÿßÿ®ÿßŸÜ (Street)' },
            { value: 'cafe', label: '⁄©ÿßŸÅŸá (Cafe)' },
            { value: 'office', label: 'ÿßÿØÿßÿ±€å (Office)' },
            { value: 'home', label: 'ÿÆÿßŸÜŸá (Home)' },
            { value: 'beach', label: 'ÿ≥ÿßÿ≠ŸÑ (Beach)' },
            { value: 'park', label: 'Ÿæÿßÿ±⁄© (Park)' },
            { value: 'abstract', label: 'ÿßŸÜÿ™ÿ≤ÿßÿπ€å (Abstract)' }
        ];

        // Load all users
        async function loadUsers() {
            try {
                const response = await fetchWithAuth('/api/admin/users');
                const data = await response.json();

                if (data.success && data.users) {
                    allUsers = data.users;
                    const select = document.getElementById('selectedUser');

                    select.innerHTML = '<option value="">-- Select a user --</option>' +
                        allUsers.map(user =>
                            `<option value="${user.user_id}">${user.email}${user.is_premium ? ' ‚≠ê Premium' : ''}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Failed to load users', 'error');
            }
        }

        // Load user's content
        async function loadUserContent() {
            const select = document.getElementById('selectedUser');
            selectedUserId = select.value;

            if (!selectedUserId) {
                document.getElementById('userContent').innerHTML =
                    '<div class="empty-state">Select a user to view their content</div>';
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/admin/user-content/${selectedUserId}`);
                const data = await response.json();

                const container = document.getElementById('userContent');

                if (data.success && data.content && data.content.length > 0) {
                    container.innerHTML = data.content.map(item => `
                        <div class="content-card">
                            <img src="${item.image_url}" alt="${item.name}">
                            <div class="content-card-body">
                                <h3>${item.name}</h3>
                                <p>${item.description || 'No description'}</p>
                                <div>
                                    <span class="badge badge-${item.content_type}">${item.content_type}</span>
                                    <span class="badge badge-${item.visibility}">${item.visibility}</span>
                                    <span class="badge">${item.category}</span>
                                </div>
                                <button onclick="deleteContent(${item.id})" class="btn-delete">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state">No content for this user yet</div>';
                }
            } catch (error) {
                console.error('Error loading content:', error);
                showAlert('Failed to load user content', 'error');
            }
        }

        // Update category options
        function updateCategoryOptions() {
            const contentType = document.getElementById('contentType').value;
            const categorySelect = document.getElementById('category');
            const categories = contentType === 'model' ? modelCategories : backgroundCategories;

            categorySelect.innerHTML = categories.map(cat =>
                `<option value="${cat.value}">${cat.label}</option>`
            ).join('');
        }

        function updateSaveCategoryOptions() {
            const contentType = document.getElementById('saveContentType').value;
            const categorySelect = document.getElementById('saveCategory');
            const categories = contentType === 'model' ? modelCategories : backgroundCategories;

            categorySelect.innerHTML = categories.map(cat =>
                `<option value="${cat.value}">${cat.label}</option>`
            ).join('');
        }

        // Upload content
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedUserId) {
                showAlert('Please select a user first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('content', document.getElementById('contentFile').files[0]);
            formData.append('content_type', document.getElementById('contentType').value);
            formData.append('visibility', document.getElementById('visibility').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('name', document.getElementById('name').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('user_id', selectedUserId);

            try {
                const response = await fetchWithAuth('/api/admin/user-content/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Content uploaded successfully!', 'success');
                    document.getElementById('uploadForm').reset();
                    updateCategoryOptions();
                    loadUserContent();
                } else {
                    showAlert(data.error || 'Failed to upload', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Failed to upload content', 'error');
            }
        });

        // Generate AI image
        async function generateAIImage() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            if (!prompt) {
                showAlert('Please enter a prompt', 'error');
                return;
            }

            if (!selectedUserId) {
                showAlert('Please select a user first', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generating...';

            try {
                const aspectRatio = document.getElementById('aiAspectRatio').value;
                const contentType = document.getElementById('aiContentType').value;

                const response = await fetch('/api/generate-image-only', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        aspectRatio: aspectRatio,
                        contentType: contentType
                    })
                });

                const data = await response.json();

                console.log('‚úÖ Generate response:', data);
                console.log('üì∑ Image URL:', data.imageUrl);

                if (data.success && data.imageUrl) {
                    generatedImageData = {
                        imageUrl: data.imageUrl,
                        prompt: prompt
                    };

                    // Show preview section first
                    document.getElementById('aiPreview').style.display = 'block';

                    // Set image source and force reload
                    const imgElement = document.getElementById('generatedImage');

                    // Show loading state
                    imgElement.style.opacity = '0.5';
                    imgElement.alt = 'Loading image...';

                    imgElement.onerror = function() {
                        console.error('‚ùå Failed to load image:', data.imageUrl);
                        imgElement.style.opacity = '1';
                        imgElement.alt = 'Failed to load image';
                        showAlert('Image generated but failed to load. URL: ' + data.imageUrl, 'warning');
                    };
                    imgElement.onload = function() {
                        console.log('‚úÖ Image loaded successfully!');
                        imgElement.style.opacity = '1';
                        imgElement.alt = 'Generated image';
                    };
                    imgElement.src = data.imageUrl + '?t=' + Date.now();

                    document.getElementById('saveContentType').value = contentType;
                    document.getElementById('saveName').value = prompt.substring(0, 50);
                    updateSaveCategoryOptions();

                    showAlert('Image generated successfully! Check preview below.', 'success');
                } else {
                    console.error('‚ùå Generation failed:', data);
                    showAlert(data.error || 'Failed to generate image', 'error');
                }
            } catch (error) {
                console.error('Generation error:', error);
                showAlert('Failed to generate image: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® Generate Image';
            }
        }

        // Save generated content
        async function saveGeneratedContent() {
            if (!generatedImageData) {
                showAlert('No generated image to save', 'error');
                return;
            }

            if (!selectedUserId) {
                showAlert('Please select a user first', 'error');
                return;
            }

            try {
                // Download image as blob
                const imageResponse = await fetch(generatedImageData.imageUrl);
                const imageBlob = await imageResponse.blob();

                const formData = new FormData();
                formData.append('content', imageBlob, 'generated-image.png');
                formData.append('content_type', document.getElementById('saveContentType').value);
                formData.append('visibility', document.getElementById('saveVisibility').value);
                formData.append('category', document.getElementById('saveCategory').value);
                formData.append('name', document.getElementById('saveName').value || 'AI Generated');
                formData.append('description', `AI Generated: ${generatedImageData.prompt}`);
                formData.append('user_id', selectedUserId);

                const response = await fetchWithAuth('/api/admin/user-content/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Generated content saved successfully!', 'success');
                    discardGenerated();
                    loadUserContent();
                } else {
                    showAlert(data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save generated content', 'error');
            }
        }

        function discardGenerated() {
            generatedImageData = null;
            document.getElementById('aiPreview').style.display = 'none';
            document.getElementById('generatedImage').src = '';
            document.getElementById('aiPrompt').value = '';
        }

        // Delete content
        async function deleteContent(contentId) {
            if (!confirm('Are you sure you want to delete this content?')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/admin/user-content/${contentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Content deleted successfully', 'success');
                    loadUserContent();
                } else {
                    showAlert('Failed to delete content', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete content', 'error');
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Initialize
        updateCategoryOptions();
        updateSaveCategoryOptions();
        loadUsers();
    </script>
</body>
</html>
