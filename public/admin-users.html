<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <circle cx="20" cy="20" r="18" fill="white" opacity="0.2"/>
                    <path d="M20 10 L12 18 L20 26 L28 18 Z" fill="white"/>
                </svg>
                <span>Admin Panel</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="/admin/users" class="nav-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
                <span>Users</span>
            </a>
            <a href="/admin/content" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                <span>Content</span>
            </a>
            <a href="/admin/analytics" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"/>
                </svg>
                <span>Analytics</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <button class="btn-logout" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <div>
                <h1>User Management</h1>
                <p>Manage users, premium status, and usage limits</p>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="loadUsers()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </header>

        <div class="content-section">
            <div id="usersTable" class="loading">Loading users...</div>
        </div>
    </main>

    <script src="admin-common.js"></script>
    <script>
        async function loadUsers() {
            try {
                const response = await fetchWithAuth('/api/admin/users');
                const data = await response.json();

                const container = document.getElementById('usersTable');

                if (data.success && data.users.length > 0) {
                    container.innerHTML = `
                        <table style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f3f4f6;">
                                <tr>
                                    <th style="padding:12px; text-align:left;">Email</th>
                                    <th style="padding:12px; text-align:center;">Premium</th>
                                    <th style="padding:12px; text-align:center;">Images Used</th>
                                    <th style="padding:12px; text-align:center;">Captions</th>
                                    <th style="padding:12px; text-align:center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr style="border-bottom:1px solid #e5e7eb;">
                                        <td style="padding:12px;">${user.email}</td>
                                        <td style="padding:12px; text-align:center;">
                                            <span style="padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600; background:${user.is_premium ? '#dbeafe' : '#fef3c7'}; color:${user.is_premium ? '#1e40af' : '#92400e'};">
                                                ${user.is_premium ? 'Premium' : 'Free'}
                                            </span>
                                        </td>
                                        <td style="padding:12px; text-align:center;">${user.images_used || 0}/${user.images_limit || 10}</td>
                                        <td style="padding:12px; text-align:center;">${user.captions_used || 0}/${user.captions_limit || 5}</td>
                                        <td style="padding:12px; text-align:center;">
                                            <button onclick="togglePremium('${user.user_id}', ${!user.is_premium})" style="padding:8px 16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer;">
                                                ${user.is_premium ? 'Remove Premium' : 'Make Premium'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state">No users found</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users', 'error');
            }
        }

        async function togglePremium(userId, makePremium) {
            try {
                const response = await fetchWithAuth(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_premium: makePremium,
                        images_limit: makePremium ? 1000 : 10,
                        captions_limit: makePremium ? 500 : 5
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`User ${makePremium ? 'upgraded to' : 'downgraded from'} premium`, 'success');
                    loadUsers();
                } else {
                    showNotification('Failed to update user', 'error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('Failed to update user', 'error');
            }
        }

        loadUsers();
    </script>
</body>
</html>
