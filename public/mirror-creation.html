<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror Creation - Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù…Ø´Ø§Ø¨Ù‡ Ø±Ù‚ÛŒØ¨</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .mirror-wizard-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Progress Steps */
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 1;
            transition: width 0.3s ease;
        }

        .wizard-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #9ca3af;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .wizard-step.active .step-circle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .wizard-step.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .step-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
        }

        .wizard-step.active .step-label {
            color: #667eea;
            font-weight: 700;
        }

        /* Step Content */
        .step-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            min-height: 400px;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-header h2 {
            font-size: 26px;
            color: #1f2937;
            margin: 0 0 10px 0;
        }

        .step-header p {
            color: #6b7280;
            font-size: 15px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 16px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9fafb;
            position: relative;
        }

        .upload-area * {
            pointer-events: none;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #374151;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: #9ca3af;
        }

        .file-preview {
            margin-top: 20px;
            text-align: center;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Model Grid */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .model-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .model-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .model-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .model-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .model-card .checkmark {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #10b981;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .model-card.selected .checkmark {
            display: flex;
        }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .btn-wizard {
            padding: 14px 30px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }

        .btn-prev {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-prev:hover {
            background: #f9fafb;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-generate {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        /* Summary Section */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .summary-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .summary-value {
            font-weight: 700;
            color: #1f2937;
        }

        .cost-info {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }

        .cost-info strong {
            font-size: 24px;
            color: #92400e;
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .models-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mirror-wizard-container">
            <!-- Progress Steps -->
            <div class="wizard-progress">
                <div class="progress-line" id="progressLine" style="width: 0%"></div>

                <div class="wizard-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Ø¹Ú©Ø³ Ù…Ø±Ø¬Ø¹</div>
                </div>

                <div class="wizard-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</div>
                </div>

                <div class="wizard-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Ø¢Ù¾Ù„ÙˆØ¯ Ù„Ø¨Ø§Ø³</div>
                </div>

                <div class="wizard-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">ØªÙˆÙ„ÛŒØ¯</div>
                </div>

                <div class="wizard-step" data-step="5">
                    <div class="step-circle">âœ“</div>
                    <div class="step-label">Ù†ØªÛŒØ¬Ù‡</div>
                </div>
            </div>

            <!-- Step 1: Reference Image -->
            <div class="step-content active" data-step="1">
                <div class="step-header">
                    <h2>ğŸ“¸ Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ Ù…Ø±Ø¬Ø¹</h2>
                    <p>Ø¹Ú©Ø³ Ø±Ù‚ÛŒØ¨ ÛŒØ§ Ø¨Ø±Ù†Ø¯ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯ - Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø§Ø² Ø§ÛŒÙ† Ø¹Ú©Ø³ Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                </div>

                <div class="upload-area" id="referenceUploadArea">
                    <input type="file" id="referenceInput" accept="image/*" style="display: none;">
                    <div class="upload-icon">ğŸ–¼ï¸</div>
                    <div class="upload-text">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¹Ú©Ø³ Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯</div>
                    <div class="upload-hint">ÙØ±Ù…Øª: JPG, PNG - Ù‡Ù…Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª (Ø­Ø¬Ø§Ø¨ØŒ Ø¹ÛŒÙ†Ú©ØŒ Ú©Ù„Ø§Ù‡ØŒ ...) Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                </div>

                <div class="file-preview" id="referencePreview"></div>

                <div class="wizard-nav">
                    <button class="btn-wizard btn-prev" onclick="location.href='/app'" style="flex: 0.3;">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    <button class="btn-wizard btn-next" id="step1Next" disabled onclick="nextStep()">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ â†</button>
                </div>
            </div>

            <!-- Step 2: Select Model -->
            <div class="step-content" data-step="2">
                <div class="step-header">
                    <h2>ğŸ‘¤ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</h2>
                    <p>Ù…Ø¯Ù„ÛŒ Ú©Ù‡ Ù…Ø­ØµÙˆÙ„ Ø´Ù…Ø§ Ø±ÙˆÛŒ Ø¢Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                </div>

                <div class="category-selector" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø¯Ù„:</label>
                    <select id="categorySelect" class="category-dropdown" onchange="handleCategoryChange(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="brand-woman">ğŸ‘©â€ğŸ’¼ Ø²Ù† Ø¨Ø±Ù†Ø¯ (Brand Woman)</option>
                        <option value="brand-man">ğŸ‘¨â€ğŸ’¼ Ù…Ø±Ø¯ Ø¨Ø±Ù†Ø¯ (Brand Man)</option>
                        <option value="brand-girl">ğŸ‘§â€ğŸ’¼ Ø¯Ø®ØªØ± Ø¨Ø±Ù†Ø¯ (Brand Girl)</option>
                        <option value="brand-boy">ğŸ‘¦â€ğŸ’¼ Ù¾Ø³Ø± Ø¨Ø±Ù†Ø¯ (Brand Boy)</option>
                        <option value="brand-plus-size">â•â€ğŸ’¼ Ø³Ø§ÛŒØ² Ø¨Ø²Ø±Ú¯ Ø¨Ø±Ù†Ø¯ (Brand Plus Size)</option>
                    </select>
                </div>

                <div class="models-grid" id="modelsGrid"></div>

                <div class="wizard-nav">
                    <button class="btn-wizard btn-prev" onclick="prevStep()">â†’ Ù‚Ø¨Ù„ÛŒ</button>
                    <button class="btn-wizard btn-next" id="step2Next" disabled onclick="nextStep()">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ â†</button>
                </div>
            </div>

            <!-- Step 3: Upload Garment -->
            <div class="step-content" data-step="3">
                <div class="step-header">
                    <h2>ğŸ‘• Ø¢Ù¾Ù„ÙˆØ¯ Ù…Ø­ØµÙˆÙ„ Ø´Ù…Ø§</h2>
                    <p>Ù„Ø¨Ø§Ø³ ÛŒØ§ Ù…Ø­ØµÙˆÙ„ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø±Ø¬Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯</p>
                </div>

                <div class="upload-area" id="garmentUploadArea">
                    <input type="file" id="garmentInput" accept="image/*" style="display: none;">
                    <div class="upload-icon">ğŸ‘”</div>
                    <div class="upload-text">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¹Ú©Ø³ Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯</div>
                    <div class="upload-hint">ÙØ±Ù…Øª: JPG, PNG - Ø¹Ú©Ø³ Ø³Ø§Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„ Ú©Ø§ÙÛŒ Ø§Ø³Øª</div>
                </div>

                <div class="file-preview" id="garmentPreview"></div>

                <div class="wizard-nav">
                    <button class="btn-wizard btn-prev" onclick="prevStep()">â†’ Ù‚Ø¨Ù„ÛŒ</button>
                    <button class="btn-wizard btn-next" id="step3Next" disabled onclick="nextStep()">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ â†</button>
                </div>
            </div>

            <!-- Step 4: Summary & Generate -->
            <div class="step-content" data-step="4">
                <div class="step-header">
                    <h2>âœ¨ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯</h2>
                    <p>Ù…Ø´Ø®ØµØ§Øª Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯</p>
                </div>

                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Ø¹Ú©Ø³ Ù…Ø±Ø¬Ø¹</div>
                        <div id="summaryReference"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Ù…Ø¯Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</div>
                        <div id="summaryModel"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Ù…Ø­ØµÙˆÙ„ Ø´Ù…Ø§</div>
                        <div id="summaryGarment"></div>
                    </div>
                </div>

                <div class="cost-info">
                    ğŸ’° Ù‡Ø²ÛŒÙ†Ù‡: <strong>1 Ø§Ø¹ØªØ¨Ø§Ø±</strong>
                    <div style="font-size: 14px; color: #92400e; margin-top: 8px;">
                        Ù‡Ù…Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ú©Ø³ Ù…Ø±Ø¬Ø¹ (Ø­Ø¬Ø§Ø¨ØŒ Ø¹ÛŒÙ†Ú©ØŒ Ú©Ù„Ø§Ù‡ØŒ Ù†ÙˆØ±ØŒ Ø²Ø§ÙˆÛŒÙ‡ØŒ ...) Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    </div>
                </div>

                <div class="wizard-nav">
                    <button class="btn-wizard btn-prev" onclick="prevStep()">â†’ Ù‚Ø¨Ù„ÛŒ</button>
                    <button class="btn-wizard btn-generate" onclick="generateMirror()">ğŸ¨ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±</button>
                </div>
            </div>

            <!-- Step 5: Result -->
            <div class="step-content" data-step="5">
                <div class="step-header">
                    <h2>ğŸ‰ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯!</h2>
                    <p>Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§</p>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <img id="resultImage" src="" alt="Generated Image" style="max-width: 100%; max-height: 600px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                </div>

                <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center;">
                    <div style="font-size: 18px; font-weight: 600; color: #166534; margin-bottom: 8px;">
                        âœ… ØªØµÙˆÛŒØ± Ø¯Ø± Ú¯Ø§Ù„Ø±ÛŒ Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯
                    </div>
                    <div style="font-size: 14px; color: #15803d;">
                        Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ú¯Ø§Ù„Ø±ÛŒ ØªØµØ§ÙˆÛŒØ± Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø¹Ú©Ø³ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
                    </div>
                </div>

                <div class="wizard-nav">
                    <button class="btn-wizard btn-prev" onclick="location.href='/gallery.html'" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">ğŸ–¼ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø§Ù„Ø±ÛŒ</button>
                    <button class="btn-wizard btn-next" onclick="location.reload()" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">ğŸ”„ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±...</h3>
            <p style="color: #6b7280; margin-top: 10px;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ØŒ Ø§ÛŒÙ† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯</p>
        </div>
    </div>

    <!-- script.js removed - causes conflicts with wizard-specific code -->
    <script>
        // ============================================
        // AUTH CHECK - Require login
        // ============================================
        (function checkAuth() {
            const token = localStorage.getItem('supabase_token');
            const session = localStorage.getItem('supabase_session');

            if (!token || !session) {
                console.log('âš ï¸ No auth credentials - redirecting to login');
                window.location.replace('/auth');
                return;
            }
            console.log('âœ… User is authenticated');
        })();

        let currentStep = 1;
        let wizardData = {
            referenceFile: null,
            referenceUrl: null,
            selectedModel: null,
            garmentFile: null,
            garmentUrl: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupUploads();
            loadModelsForWizard();
        });

        // Setup upload areas
        function setupUploads() {
            // Reference upload
            const referenceArea = document.getElementById('referenceUploadArea');
            const referenceInput = document.getElementById('referenceInput');

            referenceArea.addEventListener('click', () => referenceInput.click());
            referenceInput.addEventListener('change', (e) => handleReferenceUpload(e.target.files[0]));

            // Drag & drop
            referenceArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                referenceArea.style.borderColor = '#667eea';
            });
            referenceArea.addEventListener('dragleave', () => {
                referenceArea.style.borderColor = '#d1d5db';
            });
            referenceArea.addEventListener('drop', (e) => {
                e.preventDefault();
                handleReferenceUpload(e.dataTransfer.files[0]);
            });

            // Garment upload (same pattern)
            const garmentArea = document.getElementById('garmentUploadArea');
            const garmentInput = document.getElementById('garmentInput');

            garmentArea.addEventListener('click', () => garmentInput.click());
            garmentInput.addEventListener('change', (e) => handleGarmentUpload(e.target.files[0]));

            garmentArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                garmentArea.style.borderColor = '#667eea';
            });
            garmentArea.addEventListener('dragleave', () => {
                garmentArea.style.borderColor = '#d1d5db';
            });
            garmentArea.addEventListener('drop', (e) => {
                e.preventDefault();
                handleGarmentUpload(e.dataTransfer.files[0]);
            });
        }

        // Handle reference upload
        function handleReferenceUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            wizardData.referenceFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                wizardData.referenceUrl = e.target.result;
                document.getElementById('referencePreview').innerHTML = `
                    <img src="${e.target.result}" alt="Reference">
                    <div style="margin-top: 10px; color: #10b981; font-weight: 600;">âœ“ Ø¹Ú©Ø³ Ù…Ø±Ø¬Ø¹ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯</div>
                `;
                document.getElementById('referenceUploadArea').classList.add('has-file');
                document.getElementById('step1Next').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Handle garment upload
        function handleGarmentUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            wizardData.garmentFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                wizardData.garmentUrl = e.target.result;
                document.getElementById('garmentPreview').innerHTML = `
                    <img src="${e.target.result}" alt="Garment">
                    <div style="margin-top: 10px; color: #10b981; font-weight: 600;">âœ“ Ù…Ø­ØµÙˆÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯</div>
                `;
                document.getElementById('garmentUploadArea').classList.add('has-file');
                document.getElementById('step3Next').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Load models for wizard (uses global allModels from script.js)
        let loadedModels = [];

        async function loadModelsForWizard() {
            try {
                console.log('ğŸ”„ Loading models...');
                const response = await fetch('/api/models?mode=scene-recreation');
                const models = await response.json();

                console.log('ğŸ“¦ API Response:', {
                    isArray: Array.isArray(models),
                    length: models?.length,
                    firstModel: models?.[0]
                });

                if (Array.isArray(models) && models.length > 0) {
                    loadedModels = models;
                    console.log(`âœ… Loaded ${models.length} models for mirror creation`);
                    console.log('ğŸ“‹ Categories available:', [...new Set(models.map(m => m.category))]);
                    // Display first category
                    handleCategoryChange('brand-woman');
                } else {
                    console.warn('âš ï¸ No models returned from API');
                }
            } catch (error) {
                console.error('âŒ Error loading models:', error);
            }
        }

        function handleCategoryChange(category) {
            console.log(`ğŸ”„ Changing category to: ${category}`);
            console.log(`ğŸ“Š Total models loaded: ${loadedModels.length}`);

            const filtered = loadedModels.filter(m => m.category === category);
            console.log(`ğŸ“Š Filtered models for ${category}: ${filtered.length}`);

            const grid = document.getElementById('modelsGrid');

            if (!grid) {
                console.error('âŒ modelsGrid element not found!');
                return;
            }

            if (filtered.length === 0) {
                console.warn(`âš ï¸ No models found for category: ${category}`);
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #9ca3af;">Ù…Ø¯Ù„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }

            console.log(`âœ… Rendering ${filtered.length} models`);
            grid.innerHTML = filtered.map(model => `
                <div class="model-card" onclick="selectModel('${model.id}', this, ${JSON.stringify(model).replace(/"/g, '&quot;')})">
                    <img src="${model.image || model.image_url}" alt="${model.name || 'Model'}">
                    <div class="checkmark">âœ“</div>
                </div>
            `).join('');
        }

        function selectModel(modelId, card, modelData) {
            // Remove previous selection
            document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            // Save selection
            wizardData.selectedModel = modelData || loadedModels.find(m => m.id === modelId);
            document.getElementById('step2Next').disabled = false;
        }

        // Navigation
        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                updateWizard();

                if (currentStep === 4) {
                    updateSummary();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizard();
            }
        }

        function updateWizard() {
            // Update steps
            document.querySelectorAll('.wizard-step').forEach((step, idx) => {
                const stepNum = idx + 1;
                step.classList.remove('active', 'completed');

                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update content
            document.querySelectorAll('.step-content').forEach((content, idx) => {
                content.classList.remove('active');
                if (idx + 1 === currentStep) {
                    content.classList.add('active');
                }
            });

            // Update progress line (5 steps total)
            const progress = ((currentStep - 1) / 4) * 100;
            document.getElementById('progressLine').style.width = progress + '%';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateSummary() {
            document.getElementById('summaryReference').innerHTML = `
                <img src="${wizardData.referenceUrl}" alt="Reference">
            `;
            document.getElementById('summaryModel').innerHTML = `
                <img src="${wizardData.selectedModel.image || wizardData.selectedModel.image_url}" alt="Model">
            `;
            document.getElementById('summaryGarment').innerHTML = `
                <img src="${wizardData.garmentUrl}" alt="Garment">
            `;
        }

        // Save to localStorage for gallery (matching script.js format)
        function saveToGallery(imageData) {
            try {
                const savedImages = JSON.parse(localStorage.getItem('generatedImages') || '[]');

                // Use the same format as script.js saveToLocalStorage function
                const newImage = {
                    id: Date.now(),
                    imagePath: imageData.imagePath,  // From API response
                    model: imageData.model,  // From API response
                    background: imageData.background,  // From API response
                    description: imageData.description || '',  // From API response
                    modelId: wizardData.selectedModel?.id || null,
                    backgroundId: null,
                    shotTypeId: null,
                    poseId: null,
                    created_at: new Date().toISOString()
                };

                savedImages.unshift(newImage);
                localStorage.setItem('generatedImages', JSON.stringify(savedImages));
                console.log('âœ… Image saved to gallery:', newImage);
            } catch (error) {
                console.error('âš ï¸ Could not save to gallery:', error);
            }
        }

        // Generate mirror
        async function generateMirror() {
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                // Upload reference image
                const referenceFormData = new FormData();
                referenceFormData.append('garment', wizardData.referenceFile);
                const token = localStorage.getItem('supabase_token');
                const referenceRes = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: referenceFormData
                });
                const referenceData = await referenceRes.json();

                // Upload garment
                const garmentFormData = new FormData();
                garmentFormData.append('garment', wizardData.garmentFile);
                const garmentRes = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: garmentFormData
                });
                const garmentData = await garmentRes.json();

                // Extract numeric model ID from "custom-123" format
                const modelId = wizardData.selectedModel.id.toString().replace('custom-', '');

                // Call generation API
                const response = await fetch('/api/mirror-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        reference_image_url: referenceData.filePath,
                        model_id: modelId,
                        garment_url: garmentData.filePath
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Save to localStorage for gallery (result has imagePath, model, background, description)
                    saveToGallery(result);

                    // Hide loading
                    document.getElementById('loadingOverlay').classList.remove('active');

                    // Show result image
                    document.getElementById('resultImage').src = result.imagePath;

                    // Navigate to step 5 (result page)
                    currentStep = 5;
                    updateWizard();

                    return; // Exit early to avoid running finally block
                } else {
                    throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±');
                }
            } catch (error) {
                console.error('Generation error:', error);
                alert('âŒ Ø®Ø·Ø§: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }
    </script>
</body>
</html>
